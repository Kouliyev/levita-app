<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVITA OS</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; overflow-x: hidden; }
        
        /* –ó–ê–ì–†–£–ó–ö–ê */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { border: 4px solid #eee; border-top: 4px solid #000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* –í–•–û–î */
        #login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #fff; }
        .login-card { width: 90%; max-width: 320px; text-align: center; padding: 20px; }
        .logo-img { max-width: 180px; margin-bottom: 30px; }
        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .navbar { display: flex; justify-content: space-between; align-items: center; background-color: #000; color: white; padding: 15px 20px; position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        .menu-btn { font-size: 24px; cursor: pointer; }
        .sidebar { height: 100%; width: 0; position: fixed; z-index: 200; top: 0; left: 0; background-color: #111; overflow-x: hidden; transition: 0.3s; padding-top: 60px; }
        .sidebar a { padding: 15px 30px; text-decoration: none; font-size: 18px; color: #f1f1f1; display: block; transition: 0.3s; }
        #overlay { display: none; position: fixed; width: 100%; height: 100%; top: 0; left: 0; background-color: rgba(0,0,0,0.5); z-index: 150; }
        .container { margin-top: 80px; padding: 20px; padding-bottom: 80px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .hidden { display: none !important; }

        /* –ö–ù–û–ü–ö–ò */
        .btn { padding: 14px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%; color: white; font-weight: bold; margin-bottom: 10px; }
        .btn-login { background-color: #000; color: #f1c40f; }
        .btn-add { background-color: #000; color: white; width: auto; padding: 10px 20px; float: right; font-size: 14px; }
        .btn-save { background-color: #27ae60; }
        
        /* –ó–ê–î–ê–ß–ò */
        .task-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; align-items: center; border-left: 5px solid #000; transition: 0.3s; }
        .task-card.done { opacity: 0.6; border-left-color: #ccc; background: #fafafa; }
        .task-check { width: 24px; height: 24px; margin-right: 15px; cursor: pointer; }
        .task-info { flex-grow: 1; }
        .task-title { font-weight: bold; font-size: 16px; display: block; }
        .task-desc { font-size: 13px; color: #666; margin-top: 4px; display: block; }
        .task-who { font-size: 11px; color: #0088cc; background: #e0f7fa; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        /* –ê–î–ú–ò–ù–ö–ê */
        .admin-panel { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .stats-box { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; height: 250px; }
        
        /* –ì–õ–ê–í–ù–ê–Ø */
        .home-logo-big { max-width: 80%; width: 250px; margin-top: 50px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>–ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã...</p>
    </div>

    <div id="login-screen" class="hidden">
        <div class="login-card">
            <img src="logo.png" class="logo-img">
            <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <select id="login-user">
                <option value="" disabled selected>–ö—Ç–æ —Ç—ã?</option>
                </select>
            <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn btn-login" onclick="doLogin()">–í–û–ô–¢–ò</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</p>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="navbar">
            <div class="menu-btn" onclick="toggleNav()">&#9776;</div>
            <div style="font-weight:bold;">LEVITA OS</div>
        </div>

        <div id="sidebar" class="sidebar">
            <a href="javascript:void(0)" onclick="toggleNav()" style="text-align:right; font-size:30px;">&times;</a>
            <a href="#" onclick="showPage('home')">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="#" onclick="showPage('tasks')">‚ö° –ó–∞–¥–∞—á–∏</a>
            <a href="#" onclick="showPage('plan')">üìÖ –ü–ª–∞–Ω</a>
            <a href="#" onclick="doLogout()" style="color:#ff4d4d; margin-top:50px;">–í—ã–π—Ç–∏</a>
        </div>
        <div id="overlay" onclick="toggleNav()"></div>

        <div class="container">
            
            <div id="page-home">
                <div style="text-align:center;">
                    <img src="logo.png" class="home-logo-big">
                    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="welcome-name"></span>!</h2>
                    <p style="color:#888;">–ò—Å–ø–æ–ª—å–∑—É–π –º–µ–Ω—é —Å–ª–µ–≤–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã.</p>
                </div>
            </div>

            <div id="page-tasks" class="hidden">
                
                <div id="admin-stats" class="stats-box hidden">
                    <canvas id="myChart"></canvas>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0;">–ó–∞–¥–∞—á–∏</h2>
                    <button id="btn-add-task" class="btn btn-add hidden" onclick="openAddTask()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                
                <div id="add-task-form" class="admin-panel hidden">
                    <h3>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
                    <input type="text" id="new-title" placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?">
                    <input type="text" id="new-desc" placeholder="–î–µ—Ç–∞–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    <select id="new-assignee">
                        <option value="">–î–ª—è –≤—Å–µ—Ö</option>
                    </select>
                    <button class="btn btn-save" onclick="saveTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                    <button class="btn" style="background:#ddd; color:#333;" onclick="document.getElementById('add-task-form').classList.add('hidden')">–û—Ç–º–µ–Ω–∞</button>
                </div>

                <div id="task-list"></div>
                <p id="no-tasks" class="hidden" style="color:#999; text-align:center; margin-top:20px;">–ó–∞–¥–∞—á –Ω–µ—Ç üéâ</p>
            </div>

            <div id="page-plan" class="hidden">
                <h2>üìÖ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h2>
                <div style="text-align:left; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div style="grid-column:span 2"><label>–ê–¥–º–∏–Ω</label><input type="text" id="p-admin" placeholder="–ò–º—è"></div>
                    <div><label>–ü–ª–∞–Ω (z≈Ç)</label><input type="number" id="p-target"></div>
                    <div><label>–°—Ä. —á–µ–∫</label><input type="number" id="p-price"></div>
                </div>
                <textarea id="p-data" placeholder="–í—Å—Ç–∞–≤—å —Ç–∞–±–ª–∏—Ü—É –∏–∑ Excel —Å—é–¥–∞..." style="height:100px; width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:10px;"></textarea>
                <button class="btn btn-login" onclick="genPlan()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                
                <div id="plan-res" class="hidden" style="margin-top:20px;">
                    <textarea id="plan-out" style="height:200px; width:100%; font-family:monospace;" readonly></textarea>
                    <button class="btn btn-save" onclick="copyPlan()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- –¢–í–û–ò –†–ê–ë–û–ß–ò–ï –ö–õ–Æ–ß–ò ---
        const SB_URL = 'https://rlwdsvttrfjcqbeunilr.supabase.co';
        const SB_KEY = 'sb_publishable_AvbjBkXGEiBVMj-58sjZnA_zt8mqBv3';
        
        const supabase = supabase.createClient(SB_URL, SB_KEY);
        let currentUser = null;
        let employees = [];

        // --- 1. –ó–ê–ì–†–£–ó–ö–ê ---
        async function init() {
            // –°–∫–∞—á–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            const { data, error } = await supabase.from('employees').select('*');
            
            if (error) {
                alert("–û—à–∏–±–∫–∞: " + error.message);
                return;
            }
            
            employees = data;
            const select = document.getElementById('login-user');
            const assignSelect = document.getElementById('new-assignee');
            
            employees.forEach(u => {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –≤—Ö–æ–¥–∞
                let opt = document.createElement('option');
                opt.value = u.name;
                opt.innerText = u.name;
                select.appendChild(opt);

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–¥–∞—á
                let opt2 = document.createElement('option');
                opt2.value = u.name;
                opt2.innerText = u.name;
                assignSelect.appendChild(opt2);
            });

            // –ê–≤—Ç–æ-–≤—Ö–æ–¥ (–ü–∞–º—è—Ç—å)
            const saved = localStorage.getItem('levita_user');
            if (saved) {
                const userObj = employees.find(e => e.name === saved);
                if (userObj) enterApp(userObj);
                else document.getElementById('loader').classList.add('hidden');
            } else {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }
        init();

        // --- 2. –í–•–û–î ---
        function doLogin() {
            const name = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            
            const user = employees.find(u => u.name === name);
            
            if (user && user.password === pass) {
                localStorage.setItem('levita_user', name);
                enterApp(user);
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function enterApp(user) {
            currentUser = user;
            document.getElementById('welcome-name').innerText = user.name;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // –ï—Å–ª–∏ –ê–¥–º–∏–Ω
            if (user.role === 'admin') {
                document.getElementById('btn-add-task').classList.remove('hidden');
                document.getElementById('admin-stats').classList.remove('hidden');
                loadStats();
            }
            
            showPage('home');
            loadTasks();
        }

        function doLogout() {
            localStorage.removeItem('levita_user');
            location.reload();
        }

        // --- 3. –ó–ê–î–ê–ß–ò ---
        async function loadTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = '<p style="text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
            
            const { data: tasks, error } = await supabase
                .from('tasks')
                .select('*')
                .order('id', { ascending: false });

            list.innerHTML = '';
            let count = 0;

            tasks.forEach(t => {
                // –§–∏–ª—å—Ç—Ä: –í–∏–¥–∏—Ç –ê–¥–º–∏–Ω, –∏–ª–∏ –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –¥–ª—è –≤—Å–µ—Ö, –∏–ª–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —é–∑–µ—Ä–∞
                if (currentUser.role === 'admin' || !t.assigned_to || t.assigned_to === currentUser.name) {
                    count++;
                    let doneClass = t.is_done ? 'done' : '';
                    let checkState = t.is_done ? 'checked' : '';
                    let whoBadge = t.assigned_to ? `<span class="task-who">${t.assigned_to}</span>` : '';

                    let div = document.createElement('div');
                    div.className = `task-card ${doneClass}`;
                    div.innerHTML = `
                        <input type="checkbox" class="task-check" ${checkState} onchange="toggleTask(${t.id}, this.checked)">
                        <div class="task-info">
                            <span class="task-title">${t.title} ${whoBadge}</span>
                            <span class="task-desc">${t.description || ''}</span>
                        </div>
                        ${currentUser.role === 'admin' ? `<button onclick="deleteTask(${t.id})" style="background:none;border:none;color:#aaa;">&times;</button>` : ''}
                    `;
                    list.appendChild(div);
                }
            });

            if (count === 0) document.getElementById('no-tasks').classList.remove('hidden');
            else document.getElementById('no-tasks').classList.add('hidden');
        }

        async function toggleTask(id, isDone) {
            await supabase.from('tasks').update({ is_done: isDone }).eq('id', id);
            if (currentUser.role === 'admin') loadStats();
        }

        // --- 4. –ê–î–ú–ò–ù–ö–ê ---
        function openAddTask() { document.getElementById('add-task-form').classList.remove('hidden'); }

        async function saveTask() {
            const title = document.getElementById('new-title').value;
            const desc = document.getElementById('new-desc').value;
            const who = document.getElementById('new-assignee').value;
            
            if (!title) return alert("–ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ!");

            await supabase.from('tasks').insert([{ title: title, description: desc, assigned_to: who || null }]);
            
            document.getElementById('new-title').value = '';
            document.getElementById('new-desc').value = '';
            document.getElementById('add-task-form').classList.add('hidden');
            loadTasks();
            loadStats();
        }

        async function deleteTask(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                await supabase.from('tasks').delete().eq('id', id);
                loadTasks();
                loadStats();
            }
        }

        async function loadStats() {
            const { data } = await supabase.from('tasks').select('*');
            const done = data.filter(t => t.is_done).length;
            const total = data.length;
            const notDone = total - done;

            const ctx = document.getElementById('myChart').getContext('2d');
            
            // –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ –±—ã–ª, —É–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
            if (window.myPieChart) window.myPieChart.destroy();

            window.myPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–ì–æ—Ç–æ–≤–æ', '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'],
                    datasets: [{
                        data: [done, notDone],
                        backgroundColor: ['#27ae60', '#ecf0f1']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        // --- 5. –ì–ï–ù–ï–†–ê–¢–û–† –ü–õ–ê–ù–ê (–¢–≤–æ–π —Å—Ç–∞—Ä—ã–π –¥–æ–±—Ä—ã–π –∫–æ–¥) ---
        function genPlan() {
            let raw = document.getElementById('p-data').value;
            let adm = document.getElementById('p-admin').value || "–ê–¥–º–∏–Ω";
            let trg = parseFloat(document.getElementById('p-target').value) || 0;
            let prc = parseFloat(document.getElementById('p-price').value) || 0;
            if (!raw) return alert("–í—Å—Ç–∞–≤—å —Ç–∞–±–ª–∏—Ü—É!");
            let rows = raw.split(/\r\n|\n/).map(r => r.split('\t'));
            let sessions = {}; let stats = {c60:0, c39:0, sTot:0};
            rows.forEach(c => {
                if (c.length < 5 || (c[7] && c[7].includes("Time"))) return;
                let time = c[7], grp = c[4], name = c[0], pay = c[12]||"", left = parseInt(c[13])||0;
                if (!time || !grp) return;
                let key = time + "_" + grp;
                if (!sessions[key]) sessions[key] = {t:time, g:grp, s:[], u:[]};
                let star = "";
                if (pay==="") { star = name+" - 60‚ùå"; stats.c60++; }
                else if (pay==="P≈Çatne zajƒôcia pr√≥bne") { star = name+" - 39‚úÖ"; stats.c39++; }
                else if (pay.includes("Bezp≈Çatn") && pay.includes("pr√≥bne")) { star = name+" - –ü—Ä–æ–±–Ω–æ–µ 0"; }
                if (star) { sessions[key].s.push(star); if(!pay.includes("60‚ùå")) stats.sTot++; }
                let upg = false; if (pay.includes("Prezent")) upg = true;
                let th = 0; if (pay.includes("96")) th=32; else if (pay.includes("48")) th=24; else if (pay.includes("24")) th=12; else if (pay.includes("8")) th=5;
                if (th>0 && left<=th) upg = true;
                if (upg) sessions[key].u.push(name + (pay.includes("Prezent") ? " - –ü—Ä–æ–≤–µ—Ä—å‚ùì" : ""));
            });
            stats.sTot = stats.c60 + stats.c39 + (stats.sTot - stats.c39);
            let come = Math.round(stats.c39 + (stats.c60 * 0.33));
            let newS = Math.round(come * 0.3);
            let sumS = Math.round(newS * prc);
            let diff = trg - sumS;
            let txt = `–ü–õ–ê–ù ${adm.toUpperCase()}   ${new Date().toLocaleDateString()}\n–í—ã—Ä—É—á–∫–∞: ${trg} z≈Ç\n–ó–≤–æ–Ω–∫–∏: 100\n–î–æ–∑–≤–æ–Ω—ã: 20\n–ó–∞–ø–∏—Å–∏: 5\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n`;
            Object.keys(sessions).sort().forEach(k => {
                let s = sessions[k];
                txt += `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n${s.t} - ${s.g}\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n`;
                if(s.s.length) txt += `–ó–≤—ë–∑–¥—ã üåü\n${s.s.join('\n')}\n`;
                if(s.u.length) txt += `\n–ê–ø–≥—Ä–µ–π–¥—ãüìà\n${s.u.join('\n')}\n`;
                txt += `\n`;
            });
            txt += `‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n–ó–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ: ${stats.sTot}\n–ü—Ä–∏–¥—É—Ç –ø–æ –ø–ª–∞–Ω—É: ${come}\n–ü—Ä–æ–¥–∞–∂–∏ –Ω–æ–≤—ã–º: ${newS}\n–°—É–º–º–∞: ${sumS}\nüî• –î–û –ü–õ–ê–ù–ê: ${diff}`;
            document.getElementById('plan-out').value = txt; document.getElementById('plan-res').classList.remove('hidden');
        }
        function copyPlan() { navigator.clipboard.writeText(document.getElementById('plan-out').value); alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"); }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function toggleNav() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            if (sb.style.width === '250px') {
                sb.style.width = '0'; ov.style.display = 'none';
            } else {
                sb.style.width = '250px'; ov.style.display = 'block';
            }
        }
        function showPage(id) {
            toggleNav();
            document.getElementById('page-home').classList.add('hidden');
            document.getElementById('page-tasks').classList.add('hidden');
            document.getElementById('page-plan').classList.add('hidden');
            document.getElementById('page-' + id).classList.remove('hidden');
        }
    </script>
</body>
</html>
