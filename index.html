<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVITA OS 2.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; overflow-x: hidden; }
        
        /* –ó–ê–ì–†–£–ó–ö–ê */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { border: 4px solid #eee; border-top: 4px solid #000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* –í–•–û–î */
        #login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #fff; }
        .login-card { width: 90%; max-width: 320px; text-align: center; padding: 20px; }
        .logo-img { max-width: 180px; margin-bottom: 30px; }
        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .navbar { display: flex; justify-content: space-between; align-items: center; background-color: #000; color: white; padding: 15px 20px; position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        .menu-btn { font-size: 24px; cursor: pointer; }
        .sidebar { height: 100%; width: 0; position: fixed; z-index: 200; top: 0; left: 0; background-color: #111; overflow-x: hidden; transition: 0.3s; padding-top: 60px; }
        .sidebar a { padding: 15px 30px; text-decoration: none; font-size: 18px; color: #f1f1f1; display: block; transition: 0.3s; }
        #overlay { display: none; position: fixed; width: 100%; height: 100%; top: 0; left: 0; background-color: rgba(0,0,0,0.5); z-index: 150; }
        .container { margin-top: 80px; padding: 20px; padding-bottom: 80px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .hidden { display: none !important; }

        /* –ö–ù–û–ü–ö–ò */
        .btn { padding: 14px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%; color: white; font-weight: bold; margin-bottom: 10px; }
        .btn-login { background-color: #000; color: #f1c40f; }
        .btn-add { background-color: #000; color: white; width: auto; padding: 10px 20px; float: right; font-size: 14px; }
        .btn-save { background-color: #27ae60; }
        
        /* –ó–ê–î–ê–ß–ò */
        .task-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; align-items: center; border-left: 5px solid #000; transition: 0.3s; }
        .task-card.done { opacity: 0.6; border-left-color: #ccc; background: #fafafa; }
        .task-check { width: 24px; height: 24px; margin-right: 15px; cursor: pointer; }
        .task-info { flex-grow: 1; }
        .task-title { font-weight: bold; font-size: 16px; display: block; }
        .task-desc { font-size: 13px; color: #666; margin-top: 4px; display: block; }
        .task-who { font-size: 11px; color: #0088cc; background: #e0f7fa; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        /* –ê–î–ú–ò–ù–ö–ê */
        .admin-panel { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .stats-box { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; height: 250px; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>–°–≤—è–∑—å —Å –æ–±–ª–∞–∫–æ–º...</p>
    </div>

    <div id="login-screen" class="hidden">
        <div class="login-card">
            <img src="logo.png" class="logo-img">
            <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <select id="login-user">
                <option value="" disabled selected>–ö—Ç–æ —Ç—ã?</option>
                </select>
            <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn btn-login" onclick="doLogin()">–í–û–ô–¢–ò</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</p>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="navbar">
            <div class="menu-btn" onclick="toggleNav()">&#9776;</div>
            <div style="font-weight:bold;">LEVITA OS</div>
        </div>

        <div id="sidebar" class="sidebar">
            <a href="javascript:void(0)" onclick="toggleNav()" style="text-align:right; font-size:30px;">&times;</a>
            <a href="#" onclick="showPage('tasks')">‚ö° –ó–∞–¥–∞—á–∏</a>
            <a href="#" onclick="showPage('plan')">üìÖ –ü–ª–∞–Ω</a>
            <a href="#" onclick="doLogout()" style="color:#ff4d4d; margin-top:50px;">–í—ã–π—Ç–∏</a>
        </div>
        <div id="overlay" onclick="toggleNav()"></div>

        <div class="container">
            <div id="page-tasks">
                
                <div id="admin-stats" class="stats-box hidden">
                    <canvas id="myChart"></canvas>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0;">–ó–∞–¥–∞—á–∏</h2>
                    <button id="btn-add-task" class="btn btn-add hidden" onclick="openAddTask()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                
                <div id="add-task-form" class="admin-panel hidden">
                    <h3>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
                    <input type="text" id="new-title" placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?">
                    <input type="text" id="new-desc" placeholder="–î–µ—Ç–∞–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    <select id="new-assignee">
                        <option value="">–î–ª—è –≤—Å–µ—Ö</option>
                    </select>
                    <button class="btn btn-save" onclick="saveTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                    <button class="btn" style="background:#ddd; color:#333;" onclick="document.getElementById('add-task-form').classList.add('hidden')">–û—Ç–º–µ–Ω–∞</button>
                </div>

                <div id="task-list"></div>
            </div>

            <div id="page-plan" class="hidden">
                <h2>üìÖ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h2>
                <textarea id="p-data" placeholder="–í—Å—Ç–∞–≤—å —Ç–∞–±–ª–∏—Ü—É..." style="height:100px; width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"></textarea>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                    <input type="number" id="p-target" placeholder="–ü–ª–∞–Ω (z≈Ç)">
                    <input type="number" id="p-price" placeholder="–°—Ä. —á–µ–∫">
                </div>
                <button class="btn btn-login" onclick="alert('–§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫ –∂–µ, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ!')">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // --- ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –°–£–ü–ê–ë–ï–ô–ó ---
        const SB_URL = 'https://rlwdsvttrfjcqbeunilr.supabase.co';
        const SB_KEY = 'sb_publishable_AvbjBkXGEiBVMj-58sjZnA_zt8mqBv3';
        
        const supabase = supabase.createClient(SB_URL, SB_KEY);
        let currentUser = null;
        let employees = [];

        // --- 1. –ó–ê–ì–†–£–ó–ö–ê ---
        async function init() {
            // –°–∫–∞—á–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –≤—Ö–æ–¥–∞
            const { data, error } = await supabase.from('employees').select('*');
            if (error) return alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: " + error.message);
            
            employees = data;
            const select = document.getElementById('login-user');
            employees.forEach(u => {
                let opt = document.createElement('option');
                opt.value = u.name;
                opt.innerText = u.name.toUpperCase();
                select.appendChild(opt);
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è "–ù–æ–≤–æ–π –∑–∞–¥–∞—á–∏" (–¥–ª—è –∞–¥–º–∏–Ω–∞)
            const assignSelect = document.getElementById('new-assignee');
            employees.forEach(u => {
                let opt = document.createElement('option');
                opt.value = u.name;
                opt.innerText = u.name;
                assignSelect.appendChild(opt);
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–º—è—Ç—å
            const saved = localStorage.getItem('levita_user');
            if (saved) {
                // –ò–º–∏—Ç–∞—Ü–∏—è –≤—Ö–æ–¥–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏)
                const userObj = employees.find(e => e.name === saved);
                if (userObj) enterApp(userObj);
                else document.getElementById('loader').classList.add('hidden');
            } else {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }
        init();

        // --- 2. –í–•–û–î ---
        async function doLogin() {
            const name = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            
            const user = employees.find(u => u.name === name);
            
            if (user && user.password === pass) {
                localStorage.setItem('levita_user', name);
                enterApp(user);
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function enterApp(user) {
            currentUser = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // –ï—Å–ª–∏ –ê–¥–º–∏–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏ –≥—Ä–∞—Ñ–∏–∫
            if (user.role === 'admin') {
                document.getElementById('btn-add-task').classList.remove('hidden');
                document.getElementById('admin-stats').classList.remove('hidden');
                loadStats();
            }
            
            loadTasks();
        }

        function doLogout() {
            localStorage.removeItem('levita_user');
            location.reload();
        }

        // --- 3. –ó–ê–î–ê–ß–ò ---
        async function loadTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = '<p style="text-align:center;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</p>';
            
            const { data: tasks, error } = await supabase
                .from('tasks')
                .select('*')
                .order('id', { ascending: false });

            list.innerHTML = '';

            tasks.forEach(t => {
                // –§–∏–ª—å—Ç—Ä: –í–∏–∂—É –∑–∞–¥–∞—á—É, –µ—Å–ª–∏ –æ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö, –¥–ª—è –º–µ–Ω—è, –∏–ª–∏ —è –∞–¥–º–∏–Ω
                if (currentUser.role === 'admin' || !t.assigned_to || t.assigned_to === currentUser.name) {
                    
                    let doneClass = t.is_done ? 'done' : '';
                    let checkState = t.is_done ? 'checked' : '';
                    let whoBadge = t.assigned_to ? `<span class="task-who">${t.assigned_to}</span>` : '';

                    let div = document.createElement('div');
                    div.className = `task-card ${doneClass}`;
                    div.innerHTML = `
                        <input type="checkbox" class="task-check" ${checkState} onchange="toggleTask(${t.id}, this.checked)">
                        <div class="task-info">
                            <span class="task-title">${t.title} ${whoBadge}</span>
                            <span class="task-desc">${t.description || ''}</span>
                        </div>
                        ${currentUser.role === 'admin' ? `<button onclick="deleteTask(${t.id})" style="background:none;border:none;color:#aaa;">&times;</button>` : ''}
                    `;
                    list.appendChild(div);
                }
            });
        }

        async function toggleTask(id, isDone) {
            await supabase.from('tasks').update({ is_done: isDone }).eq('id', id);
            // –ï—Å–ª–∏ –ê–¥–º–∏–Ω - –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            if (currentUser.role === 'admin') loadStats();
        }

        // --- 4. –ê–î–ú–ò–ù–ö–ê ---
        function openAddTask() {
            document.getElementById('add-task-form').classList.remove('hidden');
        }

        async function saveTask() {
            const title = document.getElementById('new-title').value;
            const desc = document.getElementById('new-desc').value;
            const who = document.getElementById('new-assignee').value;
            
            if (!title) return alert("–ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ!");

            await supabase.from('tasks').insert([{ title: title, description: desc, assigned_to: who || null }]);
            
            document.getElementById('new-title').value = '';
            document.getElementById('new-desc').value = '';
            document.getElementById('add-task-form').classList.add('hidden');
            loadTasks();
            loadStats();
        }

        async function deleteTask(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
                await supabase.from('tasks').delete().eq('id', id);
                loadTasks();
                loadStats();
            }
        }

        // --- 5. –ì–†–ê–§–ò–ö–ò (–¢–æ–ª—å–∫–æ –¥–ª—è –ê–¥–º–∏–Ω–∞) ---
        let myChart = null;
        async function loadStats() {
            const { data } = await supabase.from('tasks').select('*');
            const done = data.filter(t => t.is_done).length;
            const total = data.length;
            const notDone = total - done;

            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–ì–æ—Ç–æ–≤–æ', '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'],
                    datasets: [{
                        data: [done, notDone],
                        backgroundColor: ['#27ae60', '#ecf0f1']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function toggleNav() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            if (sb.style.width === '250px') {
                sb.style.width = '0'; ov.style.display = 'none';
            } else {
                sb.style.width = '250px'; ov.style.display = 'block';
            }
        }
        function showPage(id) {
            toggleNav();
            document.getElementById('page-tasks').classList.add('hidden');
            document.getElementById('page-plan').classList.add('hidden');
            document.getElementById('page-' + id).classList.remove('hidden');
        }
    </script>
</body>
</html>
