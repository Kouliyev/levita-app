<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVITA Team</title>
    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; overflow-x: hidden; }
        
        /* –ó–ê–ì–†–£–ó–ö–ê */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; padding: 20px; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* –í–•–û–î */
        #login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #fff; }
        .login-card { width: 90%; max-width: 320px; text-align: center; padding: 20px; }
        .logo-img { max-width: 180px; margin-bottom: 30px; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .navbar { display: flex; justify-content: space-between; align-items: center; background-color: #000; color: white; padding: 15px 20px; position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        .menu-btn { font-size: 24px; cursor: pointer; }
        .user-info { display: flex; align-items: center; font-weight: bold; }
        
        .sidebar { height: 100%; width: 0; position: fixed; z-index: 200; top: 0; left: 0; background-color: #111; overflow-x: hidden; transition: 0.3s; padding-top: 60px; }
        .sidebar a { padding: 15px 30px; text-decoration: none; font-size: 18px; color: #f1f1f1; display: block; transition: 0.3s; }
        .close-btn { position: absolute; top: 10px; right: 20px; font-size: 36px; margin-left: 50px; cursor: pointer; color: white; }
        #overlay { display: none; position: fixed; width: 100%; height: 100%; top: 0; left: 0; background-color: rgba(0,0,0,0.5); z-index: 150; }

        .container { margin-top: 80px; padding: 20px; text-align: center; padding-bottom: 80px; }
        .hidden { display: none !important; }
        
        /* –ö–ù–û–ü–ö–ò –ò –ü–û–õ–Ø */
        input, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { padding: 14px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%; margin: 5px 0; color: white; font-weight: bold; }
        .btn-login { background-color: #000; color: #f1c40f; }
        .btn-yes { background-color: #4CAF50; }
        .btn-no { background-color: #ff4d4d; }
        .btn-tg { background-color: #0088cc; }
        .btn-copy { background-color: #6c5ce7; }
        
        /* –î–õ–Ø –ì–õ–ê–í–ù–û–ô */
        .home-logo-big { max-width: 80%; width: 250px; margin-top: 50px; margin-bottom: 20px; }
        .welcome-text { color: #888; font-size: 18px; }

        /* –ó–ê–î–ê–ß–ò */
        .date-header { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #333; text-align: left; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .task-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: left; transition: 0.2s; border-left: 5px solid #000; }
        .task-card.done { opacity: 0.6; border-left-color: #ccc; }
        .task-header { display: flex; align-items: flex-start; justify-content: space-between; }
        .task-title-row { display: flex; align-items: center; width: 100%; }
        .task-checkbox { width: 24px; height: 24px; margin-right: 15px; cursor: pointer; flex-shrink: 0; }
        .task-title { font-size: 18px; font-weight: 600; color: #333; flex-grow: 1; }
        .task-done-text { text-decoration: line-through; color: #999; }
        .details-btn { background: none; border: none; color: #0088cc; cursor: pointer; font-size: 14px; font-weight: bold; margin-left: 10px; white-space: nowrap; }
        .details-content { margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px; font-size: 14px; color: #555; line-height: 1.4; display: none; border-top: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        <div id="error-log" style="color:red; margin-top:10px; font-size:12px;"></div>
    </div>

    <div id="login-screen" class="hidden">
        <div class="login-card">
            <img src="logo.png" alt="LEVITA" class="logo-img">
            <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω" autocomplete="off">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <div id="login-error" style="color:red; display:none; margin-bottom:10px;">–ù–µ–≤–µ—Ä–Ω–æ</div>
            <button class="btn btn-login" onclick="attemptLogin()">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="navbar">
            <div class="menu-btn" onclick="openNav()">&#9776;</div>
            <div class="user-info">üë§ <span id="user-name"></span></div>
        </div>

        <div id="sidebar" class="sidebar">
            <a href="javascript:void(0)" class="close-btn" onclick="closeNav()">&times;</a>
            <a href="#" onclick="showPage('home')">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="#" onclick="showPage('tasks')">‚ö° –ó–∞–¥–∞—á–∏</a>
            <a href="#" onclick="startChecklist()">üìã –ß–µ–∫-–ª–∏—Å—Ç</a>
            <a href="#" onclick="showPage('plan')">üìÖ –ü–ª–∞–Ω</a>
            <a href="#" onclick="doLogout()" style="color:#ff4d4d; margin-top:50px">–í—ã–π—Ç–∏</a>
        </div>
        <div id="overlay" onclick="closeNav()"></div>

        <div class="container">
            
            <div id="page-home">
                <img src="logo.png" alt="Levita Logo" class="home-logo-big">
                <p class="welcome-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É!</p>
                <p style="color:#aaa; margin-top:10px; font-size:14px;">–û—Ç–∫—Ä–æ–π—Ç–µ –º–µ–Ω—é —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.</p>
            </div>

            <div id="page-tasks" class="hidden">
                <div id="today-date" class="date-header"></div>
                <div id="tasks-list"></div>
                <p id="no-tasks" class="hidden" style="color:#999; margin-top:50px;">–ó–∞–¥–∞—á –Ω–µ—Ç üéâ</p>
            </div>

            <div id="page-checklist" class="hidden">
                <div style="color:#888; margin-bottom:10px;">–í–æ–ø—Ä–æ—Å <span id="q-step">1</span></div>
                <h2 id="q-text" style="min-height:60px;">...</h2>
                <div style="margin-top:40px;">
                    <button class="btn btn-yes" onclick="answer(true)">–°–î–ï–õ–ê–ù–û</button>
                    <button class="btn btn-no" onclick="answer(false)">–ù–ï –°–î–ï–õ–ê–ù–û</button>
                </div>
            </div>

            <div id="page-result" class="hidden">
                <h2>–û—Ç—á–µ—Ç –≥–æ—Ç–æ–≤</h2>
                <textarea id="final-report" style="height:200px; font-family:monospace;" readonly></textarea>
                <button class="btn btn-tg" onclick="sendTg()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
                <button class="btn" style="background:#eee; color:#333" onclick="showPage('home')">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
            </div>

            <div id="page-plan" class="hidden">
                <h2>üìÖ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ü–ª–∞–Ω–∞</h2>
                <div style="text-align:left; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div style="grid-column:span 2"><label>–ê–¥–º–∏–Ω</label><input type="text" id="p-admin" placeholder="–ò–º—è"></div>
                    <div><label>–ü–ª–∞–Ω (z≈Ç)</label><input type="number" id="p-target"></div>
                    <div><label>–°—Ä. —á–µ–∫</label><input type="number" id="p-price"></div>
                </div>
                <label style="margin-top:15px; display:block; text-align:left;">–¢–∞–±–ª–∏—Ü–∞ –∏–∑ Google:</label>
                <textarea id="p-data" placeholder="–í—Å—Ç–∞–≤—å —Ç–∞–±–ª–∏—Ü—É —Å—é–¥–∞..." style="height:100px;"></textarea>
                <button class="btn btn-login" onclick="genPlan()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                <div id="plan-res" class="hidden" style="margin-top:20px;">
                    <textarea id="plan-out" style="height:200px; font-family:monospace;" readonly></textarea>
                    <button class="btn btn-copy" onclick="copyPlan()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò (–ú–ï–ù–Ø–ô –≠–¢–û) ---
        
        // 1. –°–°–´–õ–ö–ê –ù–ê –¢–ê–ë–õ–ò–¶–£ (3 –∫–æ–ª–æ–Ω–∫–∏: –ó–∞–¥–∞—á–∞, –î–µ—Ç–∞–ª–∏, –ö—Ç–æ)
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3roa3xekBb0f5v50n5ssR7Sn7P15todLUgqk9ergBH46L9AsNr3vSLDV2sLOSvtPlxWJZPwnd_ILR/pub?output=csv";
        
        // 2. –°–ü–ò–°–û–ö –°–û–¢–†–£–î–ù–ò–ö–û–í –ò –ü–ê–†–û–õ–ò (–í –ö–û–î–ï)
        const USERS = {
            "alex": "1111",
            "maria": "2222",
            "admin": "admin",
            "kate": "5555"
        };
        // --------------------------------

        let dbTasks = [];
        const questions = ["–ó–∞–ª –ø—Ä–æ–≤–µ—Ç—Ä–µ–Ω?", "–ú—É–∑—ã–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞?", "–ö–æ–≤—Ä–∏–∫–∏ —Ä–∞–∑–ª–æ–∂–µ–Ω—ã?", "–í–æ–¥–∞ –≤ –∫—É–ª–µ—Ä–µ –µ—Å—Ç—å?", "–°–≤–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω?"];
        let reportData = [];

        // --- –ì–õ–ê–í–ù–´–ô –ó–ê–ü–£–°–ö ---
        async function init() {
            try {
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('today-date').innerText = new Date().toLocaleDateString('ru-RU', options);

                // –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∂–µ –≤–æ—à–µ–ª? (–ü–ê–ú–Ø–¢–¨)
                const savedUser = localStorage.getItem('levita_current_user');
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                let res = await fetch(SHEET_URL + "&t=" + Date.now());
                if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
                let text = await res.text();
                if (text.includes("<html")) throw new Error("–¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫—Ä—ã—Ç–∞ –ø–∞—Ä–æ–ª–µ–º!");
                
                parseCSV(text);
                
                document.getElementById('loader').classList.add('hidden');

                if (savedUser && USERS[savedUser]) {
                    loginSuccess(savedUser);
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                }

            } catch (e) {
                document.querySelector('.spinner').style.display = 'none';
                document.getElementById('error-log').innerText = e.message;
            }
        }

        function parseCSV(text) {
            let rows = text.split(/\r\n|\n/).map(row => row.split(','));
            dbTasks = [];
            for (let i = 1; i < rows.length; i++) {
                let c = rows[i];
                if (c.length < 1) continue;
                let title = c[0] ? c[0].replace(/^"|"$/g, '').trim() : "";
                let desc = c[1] ? c[1].replace(/^"|"$/g, '').trim() : "";
                let who = c[2] ? c[2].replace(/^"|"$/g, '').trim().toLowerCase() : "";
                if (title) dbTasks.push({ title, desc, who });
            }
        }
        init();

        // --- –õ–û–ì–ò–ö–ê –í–•–û–î–ê ---
        function attemptLogin() {
            let u = document.getElementById('username').value.toLowerCase().trim();
            let p = document.getElementById('password').value.trim();
            
            if (USERS[u] && USERS[u] === p) {
                localStorage.setItem('levita_current_user', u);
                loginSuccess(u);
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function loginSuccess(u) {
            window.currentUser = u;
            let displayName = u.charAt(0).toUpperCase() + u.slice(1);
            document.getElementById('user-name').innerText = displayName;
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ì–ª–∞–≤–Ω—É—é (–õ–æ–≥–æ—Ç–∏–ø), –∞ –∑–∞–¥–∞—á–∏ –≥—Ä—É–∑–∏–º –≤ —Ñ–æ–Ω–µ
            showPage('home'); 
            renderTasks();
        }

        function doLogout() {
            localStorage.removeItem('levita_current_user');
            location.reload(); 
        }

        // --- –ó–ê–î–ê–ß–ò ---
        function renderTasks() {
            let list = document.getElementById('tasks-list');
            list.innerHTML = "";
            let status = JSON.parse(localStorage.getItem('levita_tasks_v4') || "{}");
            let hasTasks = false;

            dbTasks.forEach((t, i) => {
                if (t.who === "" || t.who === window.currentUser) {
                    hasTasks = true;
                    let isDone = status[i] || false;
                    let cls = isDone ? 'task-card done' : 'task-card';
                    let textStyle = isDone ? 'task-done-text' : '';
                    let check = isDone ? 'checked' : '';
                    let detailsBtn = t.desc ? `<button class="details-btn" onclick="toggleDetails(${i})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚ñæ</button>` : '';
                    let detailsDiv = t.desc ? `<div id="details-${i}" class="details-content">${t.desc}</div>` : '';

                    let html = `
                    <div class="${cls}">
                        <div class="task-header">
                            <div class="task-title-row">
                                <input type="checkbox" class="task-checkbox" onchange="toggleTask(${i}, this)" ${check}>
                                <span class="task-title ${textStyle}">${t.title}</span>
                            </div>
                            ${detailsBtn}
                        </div>
                        ${detailsDiv}
                    </div>`;
                    list.innerHTML += html;
                }
            });

            if (!hasTasks) document.getElementById('no-tasks').classList.remove('hidden');
        }

        function toggleTask(i, cb) {
            let s = JSON.parse(localStorage.getItem('levita_tasks_v4') || "{}");
            s[i] = cb.checked;
            localStorage.setItem('levita_tasks_v4', JSON.stringify(s));
            renderTasks();
        }

        function toggleDetails(i) {
            let el = document.getElementById(`details-${i}`);
            el.style.display = (el.style.display === "block") ? "none" : "block";
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function openNav() { document.getElementById('sidebar').style.width = "250px"; document.getElementById('overlay').style.display = "block"; }
        function closeNav() { document.getElementById('sidebar').style.width = "0"; document.getElementById('overlay').style.display = "none"; }
        
        function showPage(id) {
            closeNav();
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            ['page-home','page-tasks','page-checklist','page-result','page-plan'].forEach(p => document.getElementById(p).classList.add('hidden'));
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
            document.getElementById('page-' + id).classList.remove('hidden');
        }
        
        let qStep = 0;
        function startChecklist() { showPage('checklist'); qStep = 0; reportData = []; nextQ(); }
        function nextQ() {
            if (qStep < questions.length) {
                document.getElementById('q-text').innerText = questions[qStep];
                document.getElementById('q-step').innerText = qStep + 1;
            } else { finishChecklist(); }
        }
        function answer(yes) { reportData.push((yes ? "‚úÖ " : "‚ùå ") + questions[qStep]); qStep++; nextQ(); }
        function finishChecklist() {
            showPage('result');
            let txt = `ü©∞ LEVITA CHECKLIST\nüë§ ${window.currentUser}\nüìÖ ${new Date().toLocaleString('ru')}\n\n` + reportData.join('\n');
            document.getElementById('final-report').value = txt;
        }
        function sendTg() { window.open("https://t.me/share/url?url=" + encodeURIComponent(document.getElementById('final-report').value)); }

        function genPlan() {
            let raw = document.getElementById('p-data').value;
            let adm = document.getElementById('p-admin').value || "–ê–¥–º–∏–Ω";
            let trg = parseFloat(document.getElementById('p-target').value) || 0;
            let prc = parseFloat(document.getElementById('p-price').value) || 0;
            if (!raw) return alert("–í—Å—Ç–∞–≤—å —Ç–∞–±–ª–∏—Ü—É!");
            let rows = raw.split(/\r\n|\n/).map(r => r.split('\t'));
            let sessions = {}; let stats = {c60:0, c39:0, sTot:0};
            rows.forEach(c => {
                if (c.length < 5 || (c[7] && c[7].includes("Time"))) return;
                let time = c[7], grp = c[4], name = c[0], pay = c[12]||"", left = parseInt(c[13])||0;
                if (!time || !grp) return;
                let key = time + "_" + grp;
                if (!sessions[key]) sessions[key] = {t:time, g:grp, s:[], u:[]};
                let star = "";
                if (pay==="") { star = name+" - 60‚ùå"; stats.c60++; }
                else if (pay==="P≈Çatne zajƒôcia pr√≥bne") { star = name+" - 39‚úÖ"; stats.c39++; }
                else if (pay.includes("Bezp≈Çatn") && pay.includes("pr√≥bne")) { star = name+" - –ü—Ä–æ–±–Ω–æ–µ 0"; }
                if (star) { sessions[key].s.push(star); if(!pay.includes("60‚ùå")) stats.sTot++; }
                let upg = false; if (pay.includes("Prezent")) upg = true;
                let th = 0; if (pay.includes("96")) th=32; else if (pay.includes("48")) th=24; else if (pay.includes("24")) th=12; else if (pay.includes("8")) th=5;
                if (th>0 && left<=th) upg = true;
                if (upg) sessions[key].u.push(name + (pay.includes("Prezent") ? " - –ü—Ä–æ–≤–µ—Ä—å‚ùì" : ""));
            });
            stats.sTot = stats.c60 + stats.c39 + (stats.sTot - stats.c39);
            let come = Math.round(stats.c39 + (stats.c60 * 0.33));
            let newS = Math.round(come * 0.3);
            let sumS = Math.round(newS * prc);
            let diff = trg - sumS;
            let txt = `–ü–õ–ê–ù ${adm.toUpperCase()}   ${new Date().toLocaleDateString()}\n–í—ã—Ä—É—á–∫–∞: ${trg} z≈Ç\n–ó–≤–æ–Ω–∫–∏: 100\n–î–æ–∑–≤–æ–Ω—ã: 20\n–ó–∞–ø–∏—Å–∏: 5\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n`;
            Object.keys(sessions).sort().forEach(k => {
                let s = sessions[k];
                txt += `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n${s.t} - ${s.g}\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n`;
                if(s.s.length) txt += `–ó–≤—ë–∑–¥—ã üåü\n${s.s.join('\n')}\n`;
                if(s.u.length) txt += `\n–ê–ø–≥—Ä–µ–π–¥—ãüìà\n${s.u.join('\n')}\n`;
                txt += `\n`;
            });
            txt += `‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n–ó–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ: ${stats.sTot}\n–ü—Ä–∏–¥—É—Ç –ø–æ –ø–ª–∞–Ω—É: ${come}\n–ü—Ä–æ–¥–∞–∂–∏ –Ω–æ–≤—ã–º: ${newS}\n–°—É–º–º–∞: ${sumS}\nüî• –î–û –ü–õ–ê–ù–ê: ${diff}`;
            document.getElementById('plan-out').value = txt; document.getElementById('plan-res').classList.remove('hidden');
        }
        function copyPlan() { navigator.clipboard.writeText(document.getElementById('plan-out').value); alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"); }
    </script>
</body>
</html>