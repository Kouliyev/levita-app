<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVITA OS PRO</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/chart.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; color: #333; }
        
        /* –ó–ê–ì–†–£–ó–ö–ê */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { border: 4px solid #eee; border-top: 4px solid #000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        
        /* –®–ê–ü–ö–ê */
        .header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; height: 60px;}
        .menu-icon { font-size: 24px; cursor: pointer; margin-right: 20px; }
        .motivation { font-weight: bold; font-size: 14px; color: #444; text-align: center; flex-grow: 1; }
        .user-profile { font-weight: bold; cursor: pointer; position: relative; display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 35px; height: 35px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        
        /* –í–´–ü–ê–î–ê–Æ–©–ï–ï –ú–ï–ù–Æ –ü–†–û–§–ò–õ–Ø */
        .dropdown { display: none; position: absolute; top: 50px; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 150px; }
        .dropdown button { width: 100%; padding: 10px; border: none; background: white; text-align: left; cursor: pointer; color: red; }
        .dropdown button:hover { background: #f9f9f9; }

        /* –ë–û–ö–û–í–û–ï –ú–ï–ù–Æ */
        .sidebar { height: 100%; width: 0; position: fixed; top: 0; left: 0; background-color: #111; overflow-x: hidden; transition: 0.3s; padding-top: 60px; z-index: 200; }
        .sidebar a { padding: 15px 30px; text-decoration: none; font-size: 18px; color: #f1f1f1; display: block; }
        #overlay { display: none; position: fixed; width: 100%; height: 100%; top: 0; left: 0; background: rgba(0,0,0,0.5); z-index: 150; }

        /* –ö–û–ù–¢–ï–ô–ù–ï–†–´ */
        .container { max-width: 800px; margin: 20px auto; padding: 0 20px; padding-bottom: 80px; }
        .hidden { display: none !important; }
        
        /* –ö–ê–†–¢–û–ß–ö–ò –ò –ì–†–ê–§–ò–ö–ò */
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chart-container { position: relative; height: 250px; width: 100%; }
        
        /* –≠–õ–ï–ú–ï–ù–¢–´ –§–û–†–ú */
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px; width: 100%; background: black; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .btn-green { background: #27ae60; }
        
        /* –ó–ê–î–ê–ß–ò */
        .task-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .task-item:last-child { border-bottom: none; }
        .task-done { text-decoration: line-through; color: #aaa; }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #login-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: white; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>–ó–∞–ø—É—Å–∫ LEVITA OS...</p>
    </div>

    <div id="login-screen" class="hidden">
        <img src="logo.png" style="width: 150px; margin-bottom: 20px;">
        <div style="width: 300px;">
            <h3>–í—Ö–æ–¥</h3>
            <select id="login-user"><option>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
            <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="doLogin()">–í–û–ô–¢–ò</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px; text-align:center;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</p>
        </div>
    </div>

    <div id="app" class="hidden">
        
        <div class="header">
            <div style="display:flex; align-items:center;">
                <span class="menu-icon" onclick="toggleNav()">&#9776;</span>
            </div>
            
            <div class="motivation">
                <span id="moti-name">–ò–º—è</span>, —Ç–≤–æ–π –≤–∫–ª–∞–¥ –æ—á–µ–Ω—å —Ü–µ–Ω–Ω—ã–π! üíé
            </div>

            <div class="user-profile" onclick="toggleProfile()">
                <div id="header-name">–ò–º—è</div>
                <div class="user-avatar">üë§</div>
                <div id="profile-dropdown" class="dropdown">
                    <button onclick="doLogout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>

        <div id="sidebar" class="sidebar">
            <a href="javascript:void(0)" onclick="toggleNav()" style="text-align:right;">&times;</a>
            <a href="#" onclick="showPage('home')">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="#" onclick="showPage('tasks')">‚ö° –ó–∞–¥–∞—á–∏</a>
            <a href="#" onclick="showPage('plan')">üìÖ –ü–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å</a>
            <a href="#" onclick="showPage('admin')" id="menu-admin" class="hidden">‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞</a>
        </div>
        <div id="overlay" onclick="toggleNav()"></div>

        <div id="page-home" class="container">
            <div class="card">
                <h3>üìä –ú–æ–∏ –ü—Ä–æ–¥–∞–∂–∏ (–ü–ª–∞–Ω: <span id="my-target-text">0</span> z≈Ç)</h3>
                <div class="chart-container">
                    <canvas id="chartPersonal"></canvas>
                </div>
                <p style="font-size:12px; color:#666; margin-top:10px;">*–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã</p>
            </div>

            <div class="card">
                <h3>üåç –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ —Å—Ç—É–¥–∏–∏</h3>
                <div class="chart-container">
                    <canvas id="chartTotal"></canvas>
                </div>
            </div>
        </div>

        <div id="page-tasks" class="container hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>–ó–∞–¥–∞—á–∏</h2>
                <button id="btn-add-task" class="btn btn-green hidden" style="width:auto;" onclick="toggleTaskForm()">+ –°–æ–∑–¥–∞—Ç—å</button>
            </div>
            
            <div id="add-task-form" class="card hidden">
                <h4>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h4>
                <input id="n-title" placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?">
                <input id="n-desc" placeholder="–î–µ—Ç–∞–ª–∏">
                <select id="n-assignee"><option value="">–í—Å–µ–º</option></select>
                <button class="btn" onclick="saveTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div id="task-list" class="card"></div>
        </div>

        <div id="page-plan" class="container hidden">
            <h2>üìÖ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ü–ª–∞–Ω–∞</h2>
            <div class="card">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div style="grid-column:span 2"><label>–ê–¥–º–∏–Ω</label><input type="text" id="p-admin" placeholder="–ò–º—è"></div>
                    <div><label>–ü–ª–∞–Ω (z≈Ç)</label><input type="number" id="p-target"></div>
                    <div><label>–°—Ä. —á–µ–∫</label><input type="number" id="p-price"></div>
                </div>
                <textarea id="p-data" placeholder="–í—Å—Ç–∞–≤—å —Ç–∞–±–ª–∏—Ü—É —Å—é–¥–∞..." style="height:100px; margin-top:10px;"></textarea>
                <button class="btn" onclick="genPlan()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <div id="plan-res" class="card hidden">
                <textarea id="plan-out" style="height:200px; width:100%; border:none;" readonly></textarea>
                <button class="btn btn-green" onclick="copyPlan()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <div id="page-admin" class="container hidden">
            <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            
            <div class="card">
                <h3>üîó –°—Å—ã–ª–∫–∞ –Ω–∞ Google –¢–∞–±–ª–∏—Ü—É</h3>
                <p style="font-size:12px; color:#666;">–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π CSV (–§–∞–π–ª -> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è -> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å -> –í—ã–±–µ—Ä–∏ –õ–ò–°–¢ -> CSV)</p>
                <input id="admin-sheet-url" placeholder="https://docs.google.com/...output=csv">
                <button class="btn" onclick="saveSheetUrl()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>

            <div class="card">
                <h3>üéØ –¶–µ–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (z≈Ç)</h3>
                <div id="targets-list"></div>
            </div>
        </div>

    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const SB_URL = 'https://rlwdsvttrfjcqbeunilr.supabase.co';
        const SB_KEY = 'sb_publishable_AvbjBkXGEiBVMj-58sjZnA_zt8mqBv3';
        
        let sbClient;
        let employees = [];
        let currentUser = null;
        let sheetUrl = "";

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        async function init() {
            try {
                if(!window.supabase) throw new Error("–ù–µ—Ç —Å–µ—Ç–∏");
                sbClient = window.supabase.createClient(SB_URL, SB_KEY);
                
                // 1. –ì—Ä—É–∑–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                const { data: emps } = await sbClient.from('employees').select('*').order('name');
                employees = emps || [];

                // 2. –ì—Ä—É–∑–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å—Å—ã–ª–∫—É –Ω–∞ —Ç–∞–±–ª–∏—Ü—É)
                const { data: settings } = await sbClient.from('settings').select('*').eq('key', 'sheet_url').single();
                if(settings) sheetUrl = settings.value;

                // 3. –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–∫–∏
                setupSelects();

                // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ (–ü–ê–ú–Ø–¢–¨)
                const saved = localStorage.getItem('levita_user');
                if (saved) {
                    const u = employees.find(e => e.name === saved);
                    if (u) {
                        enterApp(u);
                        return;
                    }
                }
                showLogin();

            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞: " + e.message);
                showLogin();
            }
        }

        function setupSelects() {
            const s1 = document.getElementById('login-user');
            const s2 = document.getElementById('n-assignee');
            s1.innerHTML = '<option disabled selected>–í—ã–±–µ—Ä–∏ —Å–µ–±—è</option>';
            s2.innerHTML = '<option value="">–í—Å–µ–º</option>';
            employees.forEach(u => {
                s1.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                s2.innerHTML += `<option value="${u.name}">${u.name}</option>`;
            });
        }

        // --- –í–•–û–î / –í–´–•–û–î ---
        function showLogin() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function doLogin() {
            const name = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const u = employees.find(e => e.name === name);
            
            if (u && u.password === pass) {
                localStorage.setItem('levita_user', name);
                enterApp(u);
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function doLogout() {
            localStorage.removeItem('levita_user');
            location.reload();
        }

        function enterApp(u) {
            currentUser = u;
            // UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            document.getElementById('header-name').innerText = u.name;
            document.getElementById('moti-name').innerText = u.name;
            document.getElementById('my-target-text').innerText = u.monthly_target || 0;
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');

            if (u.role === 'admin') {
                document.getElementById('menu-admin').classList.remove('hidden');
                document.getElementById('btn-add-task').classList.remove('hidden');
                renderAdminPanel();
            }

            showPage('home');
            loadTasks();
            loadCharts(); // –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        }

        // --- –ì–†–ê–§–ò–ö–ò –ò –î–ê–ù–ù–´–ï ---
        async function loadCharts() {
            if (!sheetUrl) return; // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç, –Ω–µ –≥—Ä—É–∑–∏–º

            try {
                // –ö–∞—á–∞–µ–º CSV
                const res = await fetch(sheetUrl);
                const text = await res.text();
                const rows = text.split(/\r\n|\n/).map(r => r.split(','));

                // –ò—â–µ–º –∫–æ–ª–æ–Ω–∫–∏ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º: –ò–º—è –≤ A(0), –°—É–º–º–∞ –≤ B(1) –∏–ª–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—Å—è)
                // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: –∏—â–µ–º —Å—Ç—Ä–æ–∫—É, –≥–¥–µ –µ—Å—Ç—å –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                
                let mySales = 0;
                let totalSales = 0;

                rows.forEach(row => {
                    // –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –∏—â–µ–º –∏–º—è –≤ —Å—Ç—Ä–æ–∫–µ, –±–µ—Ä–µ–º —á–∏—Å–ª–æ —Ä—è–¥–æ–º
                    const str = row.join(' ').toLowerCase();
                    
                    // –û–±—â–∞—è —Å—É–º–º–∞ (–∏—â–µ–º –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ "–ò–¢–û–ì–û" –∏–ª–∏ —Å—É–º–º–∏—Ä—É–µ–º –≤—Å–µ?)
                    // –ü–æ–∫–∞ —É–ø—Ä–æ—Å—Ç–∏–º: —Å—á–∏—Ç–∞–µ–º –≤—Å—ë
                    
                    employees.forEach(emp => {
                        if (str.includes(emp.name.toLowerCase())) {
                            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ –≤ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä –≤–æ 2 –∫–æ–ª–æ–Ω–∫–µ)
                            // –≠—Ç–æ –º–µ—Å—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥ —Ç–≤–æ—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–∞–±–ª–∏—Ü—É!
                            // –°–µ–π—á–∞—Å —è –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é, —á—Ç–æ —Å—É–º–º–∞ –≤–æ 2-–π –∫–æ–ª–æ–Ω–∫–µ (–∏–Ω–¥–µ–∫—Å 1)
                            const val = parseFloat(row[1]) || 0; 
                            if (emp.name === currentUser.name) mySales = val;
                            totalSales += val;
                        }
                    });
                });

                // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                renderPersonalChart(mySales, currentUser.monthly_target || 0);
                renderTotalChart(totalSales, 100000); // –û–±—â–∞—è —Ü–µ–ª—å –ø–æ–∫–∞ —Ö–∞—Ä–¥–∫–æ–¥ –∏–ª–∏ —Å—É–º–º–∞ —Ü–µ–ª–µ–π

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤:", e);
            }
        }

        function renderPersonalChart(actual, target) {
            const ctx = document.getElementById('chartPersonal').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['–§–∞–∫—Ç', '–¶–µ–ª—å'],
                    datasets: [{
                        label: '–í—ã—Ä—É—á–∫–∞ (z≈Ç)',
                        data: [actual, target],
                        backgroundColor: ['#3498db', '#ecf0f1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderTotalChart(actual, target) {
            const ctx = document.getElementById('chartTotal').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–°–¥–µ–ª–∞–Ω–æ', '–û—Å—Ç–∞–ª–æ—Å—å'],
                    datasets: [{
                        data: [actual, target - actual > 0 ? target - actual : 0],
                        backgroundColor: ['#27ae60', '#eee']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }


        // --- –ó–ê–î–ê–ß–ò ---
        async function loadTasks() {
            const { data } = await sbClient.from('tasks').select('*').order('id', {ascending: false});
            const list = document.getElementById('task-list');
            list.innerHTML = "";
            if (!data) return;

            data.forEach(t => {
                if (currentUser.role === 'admin' || !t.assigned_to || t.assigned_to === currentUser.name) {
                    const div = document.createElement('div');
                    div.className = "task-item";
                    div.innerHTML = `
                        <input type="checkbox" ${t.is_done ? 'checked' : ''} onchange="toggleTask(${t.id}, this.checked)" style="width:20px; margin-right:15px;">
                        <div style="flex-grow:1;">
                            <div class="${t.is_done ? 'task-done' : ''}" style="font-weight:bold;">${t.title}</div>
                            <div style="font-size:12px; color:#888;">${t.assigned_to || '–í—Å–µ–º'}</div>
                        </div>
                        ${currentUser.role === 'admin' ? `<button onclick="delTask(${t.id})" style="border:none; bg:none; color:red;">&times;</button>` : ''}
                    `;
                    list.appendChild(div);
                }
            });
        }
        
        async function toggleTask(id, val) { await sbClient.from('tasks').update({is_done: val}).eq('id', id); loadTasks(); }
        async function saveTask() {
            const t = document.getElementById('n-title').value;
            const assignee = document.getElementById('n-assignee').value;
            if(!t) return;
            await sbClient.from('tasks').insert([{title: t, assigned_to: assignee || null}]);
            document.getElementById('n-title').value = "";
            toggleTaskForm();
            loadTasks();
        }
        async function delTask(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { await sbClient.from('tasks').delete().eq('id', id); loadTasks(); } }

        // --- –ê–î–ú–ò–ù–ö–ê ---
        function renderAdminPanel() {
            document.getElementById('admin-sheet-url').value = sheetUrl;
            const list = document.getElementById('targets-list');
            list.innerHTML = "";
            
            employees.forEach(emp => {
                const div = document.createElement('div');
                div.style.marginBottom = "10px";
                div.innerHTML = `
                    <label>${emp.name}: </label>
                    <input type="number" value="${emp.monthly_target || 0}" id="target-${emp.id}" style="width:100px;">
                    <button class="btn" style="width:auto; padding:5px 10px;" onclick="saveTarget(${emp.id})">OK</button>
                `;
                list.appendChild(div);
            });
        }

        async function saveSheetUrl() {
            const url = document.getElementById('admin-sheet-url').value;
            // –ü—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ –≤—Å—Ç–∞–≤–∏—Ç—å
            const { error } = await sbClient.from('settings').upsert({ key: 'sheet_url', value: url });
            if (!error) { alert("–°—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!"); sheetUrl = url; }
            else alert("–û—à–∏–±–∫–∞: " + error.message);
        }

        async function saveTarget(id) {
            const val = document.getElementById(`target-${id}`).value;
            await sbClient.from('employees').update({ monthly_target: val }).eq('id', id);
            alert("–¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
        }

        // --- –ü–õ–ê–ù –ì–ï–ù–ï–†–ê–¢–û–† (–¢–æ—Ç –∂–µ –∫–æ–¥) ---
        function genPlan() {
            let raw = document.getElementById('p-data').value;
            let adm = document.getElementById('p-admin').value || "–ê–¥–º–∏–Ω";
            let trg = parseFloat(document.getElementById('p-target').value) || 0;
            let prc = parseFloat(document.getElementById('p-price').value) || 0;
            if (!raw) return alert("–ù–µ—Ç —Ç–∞–±–ª–∏—Ü—ã");
            let rows = raw.split(/\r\n|\n/).map(r => r.split('\t'));
            let sessions = {}; let stats = {c60:0, c39:0, sTot:0};
            rows.forEach(c => {
                if (c.length < 5 || (c[7] && c[7].includes("Time"))) return;
                let time = c[7], grp = c[4], name = c[0], pay = c[12]||"", left = parseInt(c[13])||0;
                if (!time || !grp) return;
                let key = time + "_" + grp;
                if (!sessions[key]) sessions[key] = {t:time, g:grp, s:[], u:[]};
                let star = "";
                if (pay==="") { star = name+" - 60‚ùå"; stats.c60++; }
                else if (pay==="P≈Çatne zajƒôcia pr√≥bne") { star = name+" - 39‚úÖ"; stats.c39++; }
                else if (pay.includes("Bezp≈Çatn") && pay.includes("pr√≥bne")) { star = name+" - –ü—Ä–æ–±–Ω–æ–µ 0"; }
                if (star) { sessions[key].s.push(star); if(!pay.includes("60‚ùå")) stats.sTot++; }
                let upg = false; if (pay.includes("Prezent")) upg = true;
                let th = 0; if (pay.includes("96")) th=32; else if (pay.includes("48")) th=24; else if (pay.includes("24")) th=12; else if (pay.includes("8")) th=5;
                if (th>0 && left<=th) upg = true;
                if (upg) sessions[key].u.push(name + (pay.includes("Prezent") ? " - –ü—Ä–æ–≤–µ—Ä—å‚ùì" : ""));
            });
            stats.sTot = stats.c60 + stats.c39 + (stats.sTot - stats.c39);
            let come = Math.round(stats.c39 + (stats.c60 * 0.33));
            let newS = Math.round(come * 0.3);
            let sumS = Math.round(newS * prc);
            let diff = trg - sumS;
            let txt = `–ü–õ–ê–ù ${adm.toUpperCase()}   ${new Date().toLocaleDateString()}\n–í—ã—Ä—É—á–∫–∞: ${trg} z≈Ç\n–ó–≤–æ–Ω–∫–∏: 100\n–î–æ–∑–≤–æ–Ω—ã: 20\n–ó–∞–ø–∏—Å–∏: 5\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n`;
            Object.keys(sessions).sort().forEach(k => {
                let s = sessions[k];
                txt += `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n${s.t} - ${s.g}\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n`;
                if(s.s.length) txt += `–ó–≤—ë–∑–¥—ã üåü\n${s.s.join('\n')}\n`;
                if(s.u.length) txt += `\n–ê–ø–≥—Ä–µ–π–¥—ãüìà\n${s.u.join('\n')}\n`;
                txt += `\n`;
            });
            txt += `‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n–ó–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ: ${stats.sTot}\n–ü—Ä–∏–¥—É—Ç –ø–æ –ø–ª–∞–Ω—É: ${come}\n–ü—Ä–æ–¥–∞–∂–∏ –Ω–æ–≤—ã–º: ${newS}\n–°—É–º–º–∞: ${sumS}\nüî• –î–û –ü–õ–ê–ù–ê: ${diff}`;
            document.getElementById('plan-out').value = txt; document.getElementById('plan-res').classList.remove('hidden');
        }
        function copyPlan() { navigator.clipboard.writeText(document.getElementById('plan-out').value); alert("Copied!"); }

        // --- UI ---
        function toggleNav() { 
            const s = document.getElementById('sidebar'); 
            const o = document.getElementById('overlay');
            if(s.style.width === '250px') { s.style.width = '0'; o.style.display='none'; }
            else { s.style.width = '250px'; o.style.display='block'; }
        }
        function toggleProfile() {
            const d = document.getElementById('profile-dropdown');
            d.style.display = d.style.display === 'block' ? 'none' : 'block';
        }
        function showPage(id) {
            toggleNav();
            ['page-home','page-tasks','page-plan','page-admin'].forEach(p => document.getElementById(p).classList.add('hidden'));
            document.getElementById('page-'+id).classList.remove('hidden');
        }
        function toggleTaskForm() {
            document.getElementById('add-task-form').classList.toggle('hidden');
        }

        window.onload = init;
    </script>
</body>
</html>
