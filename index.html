<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVITA OS FINAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f4f7f6; margin: 0; }
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; text-align: center; padding: 20px;}
        .spinner { border: 4px solid #eee; border-top: 4px solid #000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-msg { color: red; font-weight: bold; border: 2px solid red; padding: 20px; border-radius: 10px; background: #fff0f0; display: none; max-width: 90%; }
        
        .hidden { display: none !important; }
        .container { max-width: 600px; margin: 80px auto; padding: 20px; text-align: center; }
        .btn { padding: 15px; width: 100%; background: black; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .task-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; text-align: left; border-left: 5px solid black; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .task-card.done { opacity: 0.5; border-color: #ccc; }
        .sidebar { height: 100%; width: 0; position: fixed; z-index: 200; top: 0; left: 0; background-color: #111; overflow-x: hidden; transition: 0.3s; padding-top: 60px; }
        .sidebar a { padding: 15px 30px; text-decoration: none; font-size: 18px; color: #f1f1f1; display: block; }
        .navbar { display: flex; justify-content: space-between; align-items: center; background-color: #000; color: white; padding: 15px 20px; position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p id="loader-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–ø–æ–¥–æ–∂–¥–∏—Ç–µ 5 —Å–µ–∫)...</p>
        <div id="error-msg"></div>
        <button id="retry-btn" class="btn hidden" onclick="location.reload()" style="width: 200px; margin-top: 20px;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>

    <div id="login-screen" class="hidden container">
        <img src="logo.png" style="max-width: 150px; margin-bottom: 20px;">
        <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
        <select id="login-user"><option>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
        <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="doLogin()">–í–û–ô–¢–ò</button>
    </div>

    <div id="app" class="hidden">
        <div class="navbar">
            <span style="font-size:24px; cursor:pointer;" onclick="toggleNav()">&#9776;</span>
            <b>LEVITA OS</b>
        </div>
        <div id="sidebar" class="sidebar">
            <a href="javascript:void(0)" onclick="toggleNav()" style="text-align:right;">&times;</a>
            <a href="#" onclick="showPage('home')">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="#" onclick="showPage('tasks')">‚ö° –ó–∞–¥–∞—á–∏</a>
            <a href="#" onclick="doLogout()" style="color:red; margin-top:50px;">–í—ã–π—Ç–∏</a>
        </div>

        <div class="container" id="page-home">
            <h2>–ü—Ä–∏–≤–µ—Ç, <span id="u-name"></span>!</h2>
            <p>–ù–∞–∂–º–∏ –º–µ–Ω—é —Å–ª–µ–≤–∞.</p>
        </div>

        <div class="container hidden" id="page-tasks">
            <h2>–ó–∞–¥–∞—á–∏</h2>
            <div id="admin-panel" class="hidden" style="margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px;">
                <h3>+ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
                <input id="n-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                <select id="n-who"><option value="">–í—Å–µ–º</option></select>
                <button class="btn" onclick="saveTask()" style="background:green;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <div id="task-list"></div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://rlwdsvttrfjcqbeunilr.supabase.co';
        const SB_KEY = 'sb_publishable_AvbjBkXGEiBVMj-58sjZnA_zt8mqBv3';
        let supabase, employees = [], currentUser = null;

        // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–£–°–ö–ê ---
        async function init() {
            // –¢–ê–ô–ú–ï–†: –ï—Å–ª–∏ —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –≤—ã–¥–∞—Ç—å –æ—à–∏–±–∫—É
            const timer = setTimeout(() => {
                showError("–¢–∞–π–º-–∞—É—Ç: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–≥–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ VPN.");
            }, 7000);

            try {
                if (!window.supabase) throw new Error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Supabase –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
                supabase = window.supabase.createClient(SB_URL, SB_KEY);
                
                // –ü—Ä–æ–±—É–µ–º —Å–∫–∞—á–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                const { data, error } = await supabase.from('employees').select('*');
                
                clearTimeout(timer); // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - –æ—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä –æ—à–∏–±–∫–∏

                if (error) throw error;
                if (!data || data.length === 0) throw new Error("–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø—É—Å—Ç.");

                employees = data;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–∫–∏
                const s1 = document.getElementById('login-user');
                const s2 = document.getElementById('n-who');
                s1.innerHTML = '<option value="" disabled selected>–ö—Ç–æ —Ç—ã?</option>';
                s2.innerHTML = '<option value="">–í—Å–µ–º</option>';
                
                employees.forEach(u => {
                    s1.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                    s2.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                });

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏
                const saved = localStorage.getItem('levita_user');
                if (saved) {
                    const u = employees.find(e => e.name === saved);
                    if (u) enterApp(u); else showLogin();
                } else {
                    showLogin();
                }

            } catch (err) {
                clearTimeout(timer);
                showError(err.message);
            }
        }

        function showError(msg) {
            document.querySelector('.spinner').style.display = 'none';
            document.getElementById('loader-text').style.display = 'none';
            const el = document.getElementById('error-msg');
            el.style.display = 'block';
            el.innerHTML = `‚ö†Ô∏è –û–®–ò–ë–ö–ê:<br>${msg}`;
            document.getElementById('retry-btn').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function doLogin() {
            const name = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const u = employees.find(e => e.name === name);
            if (u && u.password === pass) {
                localStorage.setItem('levita_user', name);
                enterApp(u);
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
            }
        }

        function enterApp(u) {
            currentUser = u;
            document.getElementById('u-name').innerText = u.name;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            if (u.role === 'admin') document.getElementById('admin-panel').classList.remove('hidden');
            showPage('home');
            loadTasks();
        }

        async function loadTasks() {
            const { data } = await supabase.from('tasks').select('*').order('id', {ascending: false});
            const list = document.getElementById('task-list');
            list.innerHTML = "";
            if (data) {
                data.forEach(t => {
                    if (currentUser.role === 'admin' || !t.assigned_to || t.assigned_to === currentUser.name) {
                        let check = t.is_done ? 'checked' : '';
                        let cls = t.is_done ? 'done' : '';
                        let del = currentUser.role === 'admin' ? `<button onclick="delTask(${t.id})" style="margin-left:auto;border:none;background:none;color:red;">&times;</button>` : '';
                        list.innerHTML += `
                        <div class="task-card ${cls}">
                            <input type="checkbox" ${check} onchange="toggle(${t.id}, this.checked)" style="width:20px;height:20px;margin:0 10px 0 0;">
                            <div>
                                <b>${t.title}</b><br>
                                <small>${t.description || ''} ${t.assigned_to ? '('+t.assigned_to+')' : ''}</small>
                            </div>
                            ${del}
                        </div>`;
                    }
                });
            }
        }

        async function toggle(id, val) { await supabase.from('tasks').update({is_done: val}).eq('id', id); }
        async function saveTask() {
            const t = document.getElementById('n-title').value;
            const w = document.getElementById('n-who').value;
            if(!t) return alert("–ò–º—è –∑–∞–¥–∞—á–∏?");
            await supabase.from('tasks').insert([{title: t, assigned_to: w || null}]);
            document.getElementById('n-title').value = "";
            loadTasks();
        }
        async function delTask(id) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { await supabase.from('tasks').delete().eq('id', id); loadTasks(); }
        }

        function doLogout() { localStorage.removeItem('levita_user'); location.reload(); }
        function toggleNav() { 
            const s = document.getElementById('sidebar'); 
            s.style.width = s.style.width === '250px' ? '0' : '250px'; 
        }
        function showPage(id) {
            toggleNav();
            ['page-home', 'page-tasks'].forEach(p => document.getElementById(p).classList.add('hidden'));
            document.getElementById('page-'+id).classList.remove('hidden');
        }

        window.onload = init;
    </script>
</body>
</html>
